<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>발더스 게이트 3 한글 빌드 메이커 (Ver.7)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nanum+Gothic:wght@400;700;800&display=swap" rel="stylesheet">
  <style>
    :root { --bg:#0f1115; --card:#171a21; --text:#e7e9ee; --muted:#9aa4b2; --accent:#9b87f5; --cyan:#7cd4fd; --line:#272b36; --ok:#9bf0ae; --warn:#ffd18b; --bad:#ff8a8a; }
    *{box-sizing:border-box} body{margin:0;font-family:"Nanum Gothic", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;background:var(--bg);color:var(--text)}
    header{padding:20px 16px;border-bottom:1px solid var(--line);position:sticky;top:0;background:linear-gradient(180deg, rgba(15,17,21,.95) 0%, rgba(15,17,21,.85) 100%);backdrop-filter: blur(8px)}
    .container{max-width:1200px;margin:0 auto;padding:24px 16px}
    h1{font-size:24px;margin:0 0 4px} .sub{color:var(--muted);font-size:14px}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
    .card{grid-column: span 12;background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px}
    @media(min-width:900px){.span6{grid-column:span 6}.span4{grid-column:span 4}.span8{grid-column:span 8}.span3{grid-column:span 3}.span9{grid-column:span 9}.span12{grid-column:span 12}}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    select,input[type="number"],input[type="text"],button,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:#0d1016;color:var(--text);font-size:14px}
    select:focus,input:focus,button:focus,textarea:focus{outline:2px solid var(--accent);outline-offset:0}
    .row{display:flex;gap:8px;align-items:center} .list{display:flex;flex-wrap:wrap;gap:8px}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#121621;font-size:12px}
    .tiny{font-size:11px} .muted{color:var(--muted)} .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace}
    .tabs{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px} .tab{padding:8px 12px;border-radius:999px;border:1px solid var(--line);background:#121621;cursor:pointer} .tab.on{outline:2px solid var(--accent)}
    .pill-ok{color:var(--ok)} .pill-warn{color:var(--warn)} .pill-bad{color:var(--bad)}
    table{width:100%;border-collapse:collapse;font-size:13px} th,td{border:1px solid var(--line);padding:8px;text-align:left} th{background:#0d1016}
    /* print */
    @media print { body{background:white;color:black} header{position:static;background:transparent;border:none} .card{border:1px solid #ccc;background:white} .chip{border-color:#ddd;background:#f7f7f7;color:#111} }
  </style>
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
  <header>
    <div class="container">
      <h1>발더스 게이트 3 한글 빌드 메이커 <span class="muted">(Ver.7 · 레벨업 타임라인 + DPR/AC 시뮬레이터 + 파티 매니저)</span></h1>
      <div class="sub">타임라인(1∼12) · 전투 시뮬(명중/피해/AC) · 파티 4인 역할 분석 — JSON 저장/불러오기 지원</div>
    </div>
  </header>
  <div id="app" class="container"></div>

  <script type="text/babel">
    const CLASSES = ["파이터","팔라딘","바드","레인저","로그","위저드","소서러","클레릭","바바리안","드루이드","몽크","워락"];
    const ROLES = ["탱커","힐/버프","광역 딜","단일 딜","제어/상태","잠입/유틸"];
    const clamp=(v,min,max)=> Math.max(min, Math.min(max, v));
    const avgDice=(s)=>{ if(!s) return 0; const m=s.match(/(\d+)d(\d+)([+\-]\d+)?/i); if(!m) return parseFloat(s)||0; const n=+m[1], d=+m[2], k=m[3]? +m[3]:0; return n*(d+1)/2 + k; }
    const hitProb=(atk, ac)=> clamp((21 + atk - ac)/20, 0.05, 0.95);
    const advProb=(p)=> 1 - (1 - p)*(1 - p);
    const critProb=(adv=false)=> adv? 1 - Math.pow(0.95,2) : 0.05;

    function App(){
      const [tab, setTab] = React.useState('timeline');
      const [state, setState] = React.useState({
        name:'새 빌드',
        timeline: Array.from({length:12}, (_,i)=> ({level:i+1, cclass:'', note:'', feat:false, subclass:''})),
        sim:{ atk:7, targetAC:15, dmg:'2d6+3', attacks:2, adv:false, gwm:false, ss:false, bless:false, acBase:18, shield:false, dexMod:0 },
        party:[ {name:'플레이어', cclass:'팔라딘', roles:["탱커","단일 딜"], ac:18}, {name:'동료1', cclass:'클레릭', roles:["힐/버프"], ac:16}, {name:'동료2', cclass:'로그', roles:["잠입/유틸","단일 딜"], ac:15}, {name:'동료3', cclass:'위저드', roles:["광역 딜","제어/상태"], ac:14} ]
      });

      const toggleFeat=(i)=> setState(s=>{ const tl=[...s.timeline]; tl[i].feat=!tl[i].feat; return {...s, timeline:tl}; });
      const setTL=(i, patch)=> setState(s=>{ const tl=[...s.timeline]; tl[i]={...tl[i], ...patch}; return {...s, timeline:tl}; });

      function computeDPR(){
        const sim = state.sim; let atk = +sim.atk; let dmgAvg = avgDice(sim.dmg); let attacks = +sim.attacks; let ac = +sim.targetAC;
        if(sim.gwm||sim.ss){ atk -= 5; dmgAvg += 10; }
        if(sim.bless){ atk += 2.5; }
        let p = hitProb(atk, ac); let pc = critProb(sim.adv); if(sim.adv){ p = advProb(p); }
        const base = Math.max(0, p - pc)*dmgAvg + pc*(dmgAvg*2);
        return base * attacks;
      }
      function computeAC(){ const {acBase, shield, dexMod} = state.sim; return acBase + (shield?2:0) + Math.max(0, dexMod); }

      const setParty=(idx, patch)=> setState(s=>{ const arr=[...s.party]; arr[idx]={...arr[idx], ...patch}; return {...s, party:arr}; });
      function partyReport(){
        const roles = new Set(state.party.flatMap(m=> m.roles||[]));
        const missing = ROLES.filter(r=> !roles.has(r));
        const acAvg = Math.round(state.party.reduce((a,m)=> a + (+m.ac||0),0)/state.party.length);
        return { missing, acAvg };
      }
      const rep = partyReport();

      function exportJSON(){
        const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
        const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`${state.name||'BG3_Ver7'}.json`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      }
      function importJSON(ev){
        const f=ev.target.files?.[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{ const j=JSON.parse(r.result); setState(j);}catch(e){alert('JSON 형식 오류');}}; r.readAsText(f);
      }

      return (
        <section className="card span12">
          <div className="tabs">
            {[{k:'timeline',n:'레벨업 타임라인'},{k:'sim',n:'DPR/AC 시뮬레이터'},{k:'party',n:'파티 매니저'},{k:'io',n:'요약/저장'}].map(t=> (
              <button key={t.k} className={'tab'+(tab===t.k?' on':'')} onClick={()=>setTab(t.k)}>{t.n}</button>
            ))}
          </div>

          {tab==='timeline' && (
            <div>
              <div className="row" style={{justifyContent:'space-between',marginBottom:8}}>
                <div style={{flex:1,maxWidth:400}}>
                  <label>빌드 이름</label>
                  <input value={state.name} onChange={e=> setState(s=> ({...s, name:e.target.value})) }/>
                </div>
                <div className="muted tiny">Lv.4/8/12에서 특성(Feat) 체크 가능</div>
              </div>
              <table>
                <thead><tr><th>레벨</th><th>클래스</th><th>서브클래스</th><th>특성</th><th>선택/메모</th></tr></thead>
                <tbody>
                  {state.timeline.map((row,i)=> (
                    <tr key={i}>
                      <td>{row.level}</td>
                      <td>
                        <select value={row.cclass} onChange={e=> setTL(i,{cclass:e.target.value})}>
                          <option value="">(선택)</option>
                          {CLASSES.map(c=> <option key={c} value={c}>{c}</option>)}
                        </select>
                      </td>
                      <td><input placeholder="예) 배틀마스터/복수 등" value={row.subclass} onChange={e=> setTL(i,{subclass:e.target.value})}/></td>
                      <td style={{textAlign:'center'}}>
                        <input type="checkbox" checked={row.feat} onChange={()=> toggleFeat(i)} disabled={!([4,8,12].includes(row.level))}/>
                      </td>
                      <td><input placeholder="주문/스킬/전법 등 기록" value={row.note} onChange={e=> setTL(i,{note:e.target.value})}/></td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}

          {tab==='sim' && (
            <div className="grid">
              <div className="span6">
                <label>공격 보너스(명중)</label>
                <input type="number" value={state.sim.atk} onChange={e=> setState(s=> ({...s, sim:{...s.sim, atk:+e.target.value}}))}/>
                <label style={{marginTop:8}}>대상 AC</label>
                <input type="number" value={state.sim.targetAC} onChange={e=> setState(s=> ({...s, sim:{...s.sim, targetAC:+e.target.value}}))}/>
                <div className="row" style={{gap:12, marginTop:8}}>
                  <div style={{flex:1}}>
                    <label>피해 주사위 (평균 계산)</label>
                    <input value={state.sim.dmg} onChange={e=> setState(s=> ({...s, sim:{...s.sim, dmg:e.target.value}}))} placeholder="예) 2d6+3"/>
                  </div>
                  <div style={{width:140}}>
                    <label>턴당 공격 횟수</label>
                    <input type="number" value={state.sim.attacks} onChange={e=> setState(s=> ({...s, sim:{...s.sim, attacks:+e.target.value}}))}/>
                  </div>
                </div>
                <div className="list" style={{marginTop:8}}>
                  <button className="chip" onClick={()=> setState(s=> ({...s, sim:{...s.sim, adv:!s.sim.adv}}))} style={{borderColor: state.sim.adv? 'var(--cyan)':'var(--line)'}}>{state.sim.adv?'✓ ':''}어드밴티지</button>
                  <button className="chip" onClick={()=> setState(s=> ({...s, sim:{...s.sim, bless:!s.sim.bless}}))} style={{borderColor: state.sim.bless? 'var(--accent)':'var(--line)'}}>{state.sim.bless?'✓ ':''}블레스(+1d4)</button>
                  <button className="chip" onClick={()=> setState(s=> ({...s, sim:{...s.sim, gwm:!s.sim.gwm, ss:false}}))} style={{borderColor: state.sim.gwm? 'var(--bad)':'var(--line)'}}>{state.sim.gwm?'✓ ':''}GWM -5/+10</button>
                  <button className="chip" onClick={()=> setState(s=>( {...s, sim:{...s.sim, ss:!s.sim.ss, gwm:false}} ))} style={{borderColor: state.sim.ss? 'var(--bad)':'var(--line)'}}>{state.sim.ss?'✓ ':''}SS -5/+10</button>
                </div>
              </div>
              <div className="span6">
                <div className="section-title">결과</div>
                <div className="row" style={{gap:16}}>
                  <span className="chip">히트 확률: {(()=>{ const sim=state.sim; let atk=sim.atk+(sim.bless?2.5:0)-(sim.gwm||sim.ss?5:0); let p=hitProb(atk, sim.targetAC); if(sim.adv) p=advProb(p); return (p*100).toFixed(1)+'%'; })()}</span>
                  <span className="chip">크리 확률: { (critProb(state.sim.adv)*100).toFixed(1) }%</span>
                  <span className="chip">평균 DPR: { computeDPR().toFixed(2) }</span>
                </div>
                <hr/>
                <label>방어력 계산</label>
                <div className="row" style={{gap:12}}>
                  <div style={{width:120}}>
                    <input type="number" value={state.sim.acBase} onChange={e=> setState(s=> ({...s, sim:{...s.sim, acBase:+e.target.value}}))}/>
                    <div className="tiny muted">기본 AC</div>
                  </div>
                  <div style={{width:120}}>
                    <input type="number" value={state.sim.dexMod} onChange={e=> setState(s=> ({...s, sim:{...s.sim, dexMod:+e.target.value}}))}/>
                    <div className="tiny muted">DEX 보정(최대 룰 직접 반영)</div>
                  </div>
                  <button className="chip" onClick={()=> setState(s=> ({...s, sim:{...s.sim, shield:!s.sim.shield}}))} style={{borderColor: state.sim.shield? 'var(--ok)':'var(--line)'}}>{state.sim.shield?'✓ ':''}방패(+2)</button>
                </div>
                <div className="row" style={{marginTop:8}}>
                  <span className="chip">최종 AC: { computeAC() }</span>
                </div>
              </div>
            </div>
          )}

          {tab==='party' && (
            <div className="grid">
              {state.party.map((m,i)=> (
                <div className="card span6" key={i} style={{padding:12}}>
                  <div className="row" style={{gap:8}}>
                    <input style={{maxWidth:160}} value={m.name} onChange={e=> setParty(i,{name:e.target.value})}/>
                    <select style={{maxWidth:180}} value={m.cclass} onChange={e=> setParty(i,{cclass:e.target.value})}>
                      {CLASSES.map(c=> <option key={c} value={c}>{c}</option>)}
                    </select>
                    <input type="number" style={{width:90}} value={m.ac||0} onChange={e=> setParty(i,{ac:+e.target.value})}/>
                    <span className="tiny muted">AC</span>
                  </div>
                  <div className="list" style={{marginTop:8}}>
                    {ROLES.map(r=>{
                      const on=(m.roles||[]).includes(r);
                      const toggle=()=> setParty(i,{roles: on? (m.roles||[]).filter(x=>x!==r): [ ...(m.roles||[]), r ]});
                      return <button key={r} className="chip" onClick={toggle} style={{borderColor:on?'var(--accent)':'var(--line)'}}>{on?'✓ ':''}{r}</button>
                    })}
                  </div>
                </div>
              ))}
              <div className="card span12" style={{padding:12}}>
                <div className="section-title">분석</div>
                <div className="row" style={{gap:12, flexWrap:'wrap'}}>
                  <span className={"chip "+(rep.missing.length? 'pill-warn':'pill-ok')}>역할 커버리지: {rep.missing.length? `부족 → ${rep.missing.join(', ')}`:'양호'}</span>
                  <span className="chip">평균 AC: {rep.acAvg}</span>
                </div>
                <div className="tiny muted" style={{marginTop:6}}>※ 추후 저항 커버리지/장비 중복 경고 추가 가능</div>
              </div>
            </div>
          )}

          {tab==='io' && (
            <div>
              <div className="section-title">요약</div>
              <pre className="mono" style={{whiteSpace:'pre-wrap',margin:0}}>{JSON.stringify(state, null, 2)}</pre>
              <div className="row" style={{gap:8, marginTop:12, flexWrap:'wrap'}}>
                <button onClick={exportJSON}>JSON 내보내기</button>
                <label className="chip" style={{cursor:'pointer'}}>
                  JSON 불러오기
                  <input type="file" accept="application/json" onChange={importJSON} style={{display:'none'}} />
                </label>
              </div>
            </div>
          )}
        </section>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('app'));
    root.render(<App/>);
  </script>
</body>
</html>
